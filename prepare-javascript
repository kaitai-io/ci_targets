#!/bin/sh

. ./config

git clone https://github.com/kaitai-io/kaitai_struct_javascript_runtime "$JAVASCRIPT_RUNTIME_DIR"

NODEJS_VERSION=$(node --version)

# Mocha dropped Node.js
#  - v4 since v6.0
#  - v8 since v8.0
#  - v10 since v9.0
#  - v12 since v10.0
# , so we'll be specifically using older versions
MOCHA_VERSION=
if echo "$NODEJS_VERSION" | grep '^v4'; then
	MOCHA_VERSION="@<6"
elif echo "$NODEJS_VERSION" | grep '^v8'; then
	MOCHA_VERSION="@<8"
elif echo "$NODEJS_VERSION" | grep '^v10'; then
	MOCHA_VERSION="@<9"
elif echo "$NODEJS_VERSION" | grep '^v12'; then
	MOCHA_VERSION="@<10"
fi

cd tests

# Make sure that "node_modules" are always created in one location and avoid traversing to higher-level directories
mkdir -p node_modules

npm install "mocha$MOCHA_VERSION" iconv-lite
cd ..
